---
layout: page
title: "Раздел 6 - Практика работы с MySQL"
permalink: content-06
---

## Поддержка MySQL в PHP
PHP имеет превосходную поддержку MySQL.  
Специальные встроенные функции для работы с MySQL позволяют программисту просто и эффективно работать с этой СУБД:
выполнять любые запросы, читать и записывать данные, обрабатывать ошибки.  
Всего из нескольких строк будет состоять сценарий, реализующий подключение к БД, выполнение запроса и показ данных.  
Для работы с MySQL не надо ничего дополнительно устанавливать и настраивать, ведь все что необходимо уже доступно
вместе со стандартной поставкой PHP.

## Способы работы: PDO и mysqli
PHP предлагает на выбор два способа работы с СУБД MySQL: используя семейство функций `mysqli_` или через интерфейс доступа
к базам данных - PDO.  

### Что такое mysqli?
mysqli - это расширение PHP, которое добавляет в язык максимально полную поддержку баз данных MySQL.  
Это расширение поддерживает множество возможностей современных версий MySQL.

### Что такое PDO?
Как известно, MySQL - это не единственная реляционная СУБД, с которой можно работать в PHP. Есть и множество других
альтернатив.  
Расширение PDO предлагает простой и унифицированный интерфейс для доступа к базам данных в PHP. Это значит, что вне
зависимости от того, какая конкретная база данных используется, вы можете пользоваться одними и теми функциями для
выполнения запросов и выборки данных.

### Что использовать?
Для работы с MySQL из PHP мы будем использовать функции и расширение `mysqli`, потому что, как правило, необходимость
поменять используемую базу данных в реальной жизни встречается крайне редко, зато работая с mysqli программист получит
более качественную поддержку MySQL и лучшую производительность.

## Как выглядит работа с базой данных
Типичный процесс работы с СУБД в PHP-сценарии состоит из нескольких шагов:
1. Установить подключение к серверу СУБД, передав необходимые параметры: адрес, логин, пароль
2. Убедиться, что подключение прошло успешно: сервер СУБД доступен, логин и пароль верные и т.д.
3. Сформировать правильный SQL запрос (например, на чтение данных из таблицы)
4. Убедиться, что запрос был выполнен успешно
5. Получить результат от СУБД в виде массива из записей
6. Использоваеть полученные записи в своем сценарии (например, показать их в виде таблицы)

## Соединение с MySQL
Перед тем, как начать работать с данными внутри MySQL, вам необходимо открыть соединение с сервером СУБД.  
В PHP вы можете с легкостью сделать это, используя специальную функцию `mysqli_connect()`.  
Всё дальнейшее взаимодействие между PHP и MySQL будет происходить через это соединение.  
Но чтобы выполнить соединение с сервером, нам необходимо знать как минимум три параметра: адрес сервера СУБД, логин и
пароль.  

Если вы следовали стандартной процедуре установки MySQL или используете OpenServer, то адресом сервера будет `localhost`,
логином - `root`.
При использовании OpenServer пароль для подключения - это пустая строка '', а при самостоятельной установке MySQL пароль
вы задавали в одном из шагов мастера установки.

Базовый синтаксис функции `mysqli_connect()`:
```
mysqli_connect(<адрес сервера>, <имя пользователя>, <пароль>, <имя базы данных>);
```

### Проверка соединения
*Первое, что нужно сделать после соединения с СУБД - это выполнить проверку, что оно было успешным.*  
Много что может пойти не так: были использованы неверные параметры подключения, неправильная настройка или высокая
нагрузка заставит MySQL отвеграть новые подключения. Все эти ситуации приведут к невозможности соединения, поэтому
программист должен проверить успешность подключения к серверу, прежде чем выполнять следующие действия.  

Соединение с MySQL устанавливается один раз в сценарии, а затем используется при всех запросах к БД.  
Результатом выполнения функции `mysqli_connect()` будет значение специального типа - ресурс.   
Если подключение к MySQL не удалось, то функция `mysqli_connect()` вместо ресурса вернет логическое значение типа
"ложь"  - `false`.  
Хорошей практикой будет всегда проверять значение результа выполнения этой функции и сравнивать его с ложью.  

Так может выглядеть пример подключения и проверки его успешности:
```
<?php
$link = mysqli_connect("localhost", "root", "");

if ($link == false){
    print("Ошибка: Невозможно подключиться к MySQL " . mysqli_connect_error());
}
else {
    print("Соединение установлено успешно");
}
```

Функция `mysqli_connect_error()` просто возвращает текстовое описание последней ошибки MySQL.

## Добавление записи
Вернемся к нашему проекту - дневнику наблюдений за погодой.  Начнем практическую работу с заполнения таблиц данными.  
Для начала добавим хотя бы один город в таблицу cities.  

Выражение `INSERT INTO` используется для добавления новых записей в таблицу базы данных.  

Составим корректный SQL запрос на вставку записи с именем города, а затем выполним его путем передачи этого запроса в
функцию `mysqli_query()`, чтобы добавить новые данные в таблицу.

```
<?php
$link = mysqli_connect("localhost", "root", "");

$sql = 'INSERT INTO cities SET name = "Санкт-Петербург"';
$result = mysqli_query($link, $sql);  

if ($result == false) {
    print("Произошла ошибка при выполнении запроса");
}
```

Обратите внимание, что первым параметром для функциии `mysqli_query()` передается ресурс подключения, полученный от
выполнения функции `mysqli_connect()`, вторым параметром следует строка с SQL запросом.  
При запросах на изменение данных (не SELECT) результатом выполнения будет логическое значение - true или false.    
`false` будет означать, что запрос выполнить не удалось.
Для получения строки с описанием ошибки существует функция `mysqli_error($link)`.

### Как получить идентификатор добавленной записи
Следующим шагом будет добавление погодной записи для нового города.  
Погодные записи хранит таблица weather_log, ну чтобы сослаться на город необходимо знать идентификатор записи из таблицы
cities.  
На помощь придет функция `mysqli_insert_id()`.  
Она принимает единственный аргумент - ресурс соединения, а возвращает идентификатор последней добавленной записи.

Теперь у нас есть все необходимое, чтобы добавить погодную запись.  
Вот как будет выглядеть комплексный пример с подключением к MySQL и добавлением двух новых записей:

```
<?php
$link = mysqli_connect("localhost", "root", "");

if ($link == false){
    print("Ошибка: Невозможно подключиться к MySQL " . mysqli_connect_error());
}
else {
    $sql = 'INSERT INTO cities SET name = "Санкт-Петербург"';
    $result = mysqli_query($link, $sql);  

    if ($result == false) {
        print("Произошла ошибка при выполнении запроса");
    }
    else {
        $city_id = mysqli_insert_id($link);

        $sql = 'INSERT INTO weather_log SET city_id = ' . $city_id . ', day = "2017-09-03", temperature = 10, cloud = 1';

        $result = mysqli_query($link, $sql);  

        if ($result == false) {
            print("Произошла ошибка при выполнении запроса");
        }
    }
}
```

## Чтение записей
Вторая частая операция при работе с базами данных в PHP - это получение записей из таблиц (запросы типа SELECT).  
Давайте составим SQL запрос, который будет использовать `SELECT` выражение, затем выполним этот запрос с помощью
функции `mysqli_query()`, чтобы получить данные из таблицы.

В этом примере показано как выполнить показ всех существующих городов из таблицы cities:
```
<?php

$sql = 'SELECT id, name FROM cities';

$result = mysqli_query($link, $sql);

while ($row = mysqli_fetch_array($result)) {
    print("Город: " . $row['name'] . "; Идентификатор: . " . $row['id'] . "<br>");
}
```

В примере выше, результат выполнения функции `mysqli_query()` сохранен в переменной `$result`.  
Важно понимать, что в этой переменной находятся не данные из таблицы, а специальный тип данных - так называемая ссылка
на результаты запроса.  

Чтобы получить действительные данные, т.е. записи из таблицы, следует использовать другую функцию -
`mysqli_fetch_array()` и передать ей единственным параметром эту самую ссылку.  
Теперь каждый вызов функции `mysqli_fetch_array()` будет возвращать следующую запись из всего результатируещего набора
записей в виде ассоциативного массива.

Цикл `while` здесь используется для "прохода" по всем записям из полученного набора записей.  
Значение поля каждой записи можно узнать просто обратившись по ключу этого ассоциативного массива.

### Как узнать количество записей
Часто бывает необходимо узнать сколько всего записей вернет выполненный SQL запрос.  
Это может быть нужно для организации постраничной навигации или просто в качестве информации.  
Узнать число записей поможет функция `mysqli_num_rows()`, которой следует передать ссылку на результат запроса.

## Транзакции
Транзакции в MySQL - это способ выполнить несколько запросов подряд таким образом, чтобы были успешно выполнены все
запросы, либо ни одного. Это нужно, чтобы обеспечить консистентность данных. Поясним на примере:  
предположим, ваше веб-приложение работает с финансовыми аккаунтами пользователей и позволяет выполнить перевод внутренней
валюты с одного счета на другой.  
Это означает, что необходимо последовательно выполнить два запроса:
1. Уменьшить баланс первого пользователя на сумму перевода
2. Увелиичить баланс второго пользователя на сумму перевода

Но что будет, если первый запрос выполнится, а второй нет? Причиной тому может быть что угодно: отключение сервера,
ошибка в работе СУБД, ошибка в синтаксисе второго запроса и т.д.
Вне зависимости от причины, такая ситуация грозит большими проблемами: деньги у одного пользователя будут списаны, а
второму не зачислены.

## Безопасность
### Инъекция
### Экранирование
### Подготовленные выражения
