<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Раздел 4 - Хранение состояния</title>
  <meta name="description" content="Учебник по PHP от HTML Academy.">

  <link rel="stylesheet" href="assets/main.css">
  <link rel="alternate" type="application/rss+xml" title="PHP-guide" href="/feed.xml">


</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">PHP-guide</a>

    <nav class="site-nav">
      <!-- <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span> -->

      <!-- <div class="trigger">


          <a class="page-link" href="/content-01">Раздел 1 - Вводный</a>



          <a class="page-link" href="/content-02">Раздел 2 - Заканчиваем с азами</a>



          <a class="page-link" href="/content-03">Раздел 3 - HTML/HTTP/Формы</a>



          <a class="page-link" href="/content-04">Раздел 4 - Хранение состояния</a>



          <a class="page-link" href="/content-05">Раздел 5 - Реляционные базы данных: теория и практика</a>



          <a class="page-link" href="/content-06">Раздел 6 - Практика работы с MySQL</a>



          <a class="page-link" href="/content-07">Раздел 7 - Теория ООП и использование в PHP</a>






      </div> -->
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Раздел 4 - Хранение состояния</h1>
  </header>

  <div class="post-content">
    <h2 id="Особенности-работы-протокола-http">Особенности работы протокола HTTP</h2>

<p>Как вы узнали из прошлой главы, работа с веб-сайтами в интернете происходит по протоколу HTTP.<br />
Это замечательный и простой протокол, который действует по схеме “запрос-ответ”. Т.е. клиент (браузер)
пользователя посылает на сервер запрос, состоящий, как правило, только из заголовков, а затем получает
ответ в виде заголовков ответа и тела самого документа.<br />
В отличие от многих других протоколов, HTTP не сохраняет своего состояния.
Это означает отсутствие сохранения промежуточного состояния между парами “запрос-ответ”.<br />
Иными словами, сервер не “запоминает” клиентов; каждый запрос он обрабатывает с “чистого листа”.</p>

<p>Для сервера нет никакой разницы: запросил один пользователь страницу десять раз или десять разных пользователей
по разу. Для него все запросы одинаковые.</p>

<p>Чем это неудобно для нас?<br />
Часто сайты должны уметь идентифицировать своих посетителей, чтобы сохранять и показывать им позже какую либо
  информацию.<br />
Например, интернет-магазины могут сохранять историю просмотров, чтобы рекомендовать потенциальным покупателям
наиболее подходящие им товары.  Или агрегатор новостей мог бы предложить пользователям выбирать только
интересующие их рубрики.</p>

<p>К счастью, протокол HTTP, а также все браузеры предоставляют возможность сохранения информации о пользователе</p>

<h2 id="cookies">Cookies</h2>

<p>Cookies (в дальнейшем просто “куки”) - небольшие фрагменты данных, которые веб-сервер отправляет браузеру.<br />
Браузер сохраняет их у себя, а при следующем посещении веб-страницы отправляет обратно. Благодаря этому, веб-сервер
сможет узнать своего “старого” посетиля, идентифицировать его.</p>

<p>С технической стороны, куки - это обычные HTTP заголовки.<br />
Когда веб-сервер хочет записать куку в браузер пользователя, то он отсылает специальный заголовок ответа с названием
<code class="highlighter-rouge">Set-Cookie</code>. В этом заголовке должна содержаться непосредственно необходимая информация, а также дополнительные
аттрибуты, о которых пойдет речь далее.<br />
В следующий раз, когда браузер пользователя запросит веб-страницу с того же сайта, в числе прочих заголовков он
передаст заголовок запроса <code class="highlighter-rouge">Cookie</code>.  Веб сервер получит эту информацию и она будет доступна также и для PHP.</p>

<h3 id="Пример">Пример</h3>
<p>Задача очень проста: сохранять и показывать посетителю страницы сколько раз он посетил наш сайт. Для этого будем
сохранять количество посещений в отдельной куке, увеличивая значения на единицу при каждой загрузке страницы.</p>

<h3 id="Как-установить-куки">Как установить куки</h3>
<p>Являясь серверным языком программирования, PHP может управлять заголовками, которые отправляет сервер, а значит
может устанавливать и читать куки.<br />
Чтобы добавить новую куку, необходимо вначале определиться со следующими критериями:</p>
<ul>
  <li>название этой куки (может состоять только из символов латинского алфавита и цифр)</li>
  <li>значение, которое предполагается хранить</li>
  <li>срок жизни куки - это обязательное условие</li>
</ul>

<p>За установку куки в PHP отвечает функция <code class="highlighter-rouge">setcookie</code>, ей нужно передать как минимум три параметра, описанных выше.
Пример:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
setcookie("visit_count", 1, strtotime("+30 days"));
</code></pre></div></div>
<p>Обратите внимание, что срок жизни указывается в относительной величине. В этом примере кука будет существовать ровно
30 дней с момента установки.</p>

<h3 id="Как-прочитать-куки">Как прочитать куки</h3>
<p>В PHP максимально упрощен процесс чтения информации из кукисов.
Все переданные сервером куки становятся автоматически доступны в специальном глобальном массиве <code class="highlighter-rouge">$_COOKIE</code><br />
Так, чтобы получить содержимое куки с именем “visit_count”, достаточно обратиться к одноименному элементу массива
<code class="highlighter-rouge">$_COOKIE</code>, например вот так:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
print($_COOKIE["visit_count"]);
</code></pre></div></div>

<p>Обратите внимание: установив в сценарии куку через <code class="highlighter-rouge">setcookie</code>, прочитать её можно будет только при следующем посещении
страницы.</p>

<h3 id="Собираем-все-вместе">Собираем все вместе</h3>
<p>Теперь, научившись устанавливать и читать куки, напишем полноценный сценарий, который будет считать и выводить количество
посещений страницы пользователем:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
$visit_count = 1;

if (isset($_COOKIE["visit_count"])) {
    $visit_count = $_COOKIE["visit_count"] + 1;
}

setcookie("visit_count", $visit_count, strtotime("+30 days"));

print("Количество посещений: " . $visit_count);
</code></pre></div></div>

<h2 id="Сессии">Сессии</h2>
<p>Мы уже умеем сохранять информацию для пользователя между посещениями страницы с помощью кук. Но зачем же нам еще сессии и
для чего они нужны?<br />
Сессии, они же сеансы, это, по сути, просто удобная обертка над куками. Они также позволяют хранить данные, релевантные
 пользователю, но с некоторыми отличиями и ограничениями:</p>
<ul>
  <li>Данные хранятся не произвольное время, а только до закрытия вкладки с веб-страницей</li>
  <li>Чтобы сессии работали, в начале каждого сценария надо вызывать функцию <code class="highlighter-rouge">session_start()</code></li>
  <li>Доступный объем для хранения информации намного больше</li>
</ul>

<p>Используя сессии, запись и чтение информации происходит просто как работа со специальным массивом <code class="highlighter-rouge">$_SESSION</code></p>

<h3 id="Как-устроены-сессии">Как устроены сессии</h3>
<ol>
  <li>PHP генерирует уникальный идентификатор браузера</li>
  <li>Идентификатор сохраняется в специальную куку и передается с каждым запросом</li>
  <li>Все данные, которые записываются в сессию, PHP автоматически сохраняет в специальном файле на сервере</li>
</ol>

<p>Благодаря существованию сессий в PHP, мы можем сохранять любые данные так же просто, как присваивать их переменным. Но,
в отличие от переменных, эти данные будут сохраняться для пользователя между запросами в пределах сеанса.</p>

<p>Перепишем сценария для подсчета посещений, но теперь используем сессии:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
session_start();
$visit_count = 1;

if (isset($_SESSION["visit_count"])) {
    $visit_count = $_SESSION["visit_count"] + 1;
}

$_SESSION["visit_count"] = $visit_count;

print("Количество посещений: " . $visit_count);
</code></pre></div></div>

<h2 id="Аутентификация">Аутентификация</h2>
<p>Представим условный интернет-магазин. Все его страницы можно разделить на две половины: публичные и приватные.<br />
К публичным относятся страницы каталога, информации о товаре, условия доставки и т.д. К приватным - корзина покупок,
история заказов.<br />
Совершенно очевидно, что корзина покупок у каждого покупателя должна быть своя, а иметь к ней доступ должен только сам
владелец и никто больше.</p>

<p>Процедура проверки возможности доступа пользователя к определенной части сайта и называется аутентификацией.<br />
Весь процесс аутентификации всегда состоит из нескольких шагов:</p>
<ol>
  <li>При попытке доступа к закрытой части сайта, пользователь видит форму, где он должен ввести свой логин и пароль</li>
  <li>Форма отправляется, а полученные данные сравниваются с действительным логином и паролем существующего пользователя</li>
  <li>Если данные совпадают, то пользователь считается аутентифицированным и получает доступ к приватной части сайта</li>
  <li>При повторном открытии этой страницы пользователь не должен повторно вводить пароль, если он уже делал это в рамках
текущего сеанса</li>
</ol>

<p>PHP предлагает два подхода для реализации такой аутентификации.</p>

<h3 id="Базовая-http-аутентификация">Базовая HTTP-аутентификация</h3>
<p>Это самый простой способ организовать аутентификацию пользователей на своем сайте.<br />
Он заключается в том, что мы посылаем специальный заголовок - <code class="highlighter-rouge">WWW-Authenticate</code>.  Встретив этот заголовок,браузер
 автоматически покажет форму с требованием ввести логин и пароль.  Отправка формы повторно вызывает сценарий, но в этот
 раз в нем будут предопределены несколько переменных, которые будут содержать логин и пароль, введенные пользователем.<br />
РНР-сценарий может проанализировать имя пользователя и его пароль, введенные в окне диалога аутентификации, и на основании
результатов такого анализа принять решение либо о предоставлении этому пользователю доступа к защищенной странице,
либо об отклонении запроса.</p>

<p>Удобство этого метода состоит еще и в том, что браузер пользователя сам запоминает и каждый раз передает введенные
однократно логин с паролем, что избавляет нас от необходимости самостоятельно хранить эту информацию с помощью сессий
или кук.</p>

<h3 id="Веб-аутентификация">Веб-аутентификация</h3>
<p>Базовая HTTP-аутентификация имеет и свои недостатки:</p>
<ul>
  <li>это не очень безопасно</li>
  <li>внешний вид формы аутентификации никак не настраивается, т.к. выводится браузером самостоятельно</li>
  <li>нет возможности добавить дополнительные поля</li>
</ul>

<p>По этим причинам гораздо чаще используется веб-аутентификация. Этот подход требует намного больше ручной работы,
но взамен мы получаем значительные возможности для настройки.</p>

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">PHP-guide</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>

              PHP-guide

            </li>

            <li><a href="mailto:mail@htmlacademy.ru">mail@htmlacademy.ru</a></li>

        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">

          <li>
            <a href="https://github.com/htmlacademy"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">htmlacademy</span></a>

          </li>



        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Учебник по PHP от HTML Academy.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
